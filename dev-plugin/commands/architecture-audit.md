---
name: architecture-audit
description: DDD & クリーンアーキテクチャの監査を実行し、具体的な改善案を含むMarkdown形式の監査レポートを生成する
aliases:
  - arch-audit
  - ddd-clean-audit
---

DDD & クリーンアーキテクチャの監査エージェントを起動して、コードベースがDDD原則とクリーンアーキテクチャに準拠しているかを監査し、具体的な改善案を含む監査レポートを生成します。

## 使用方法

```
/architecture-audit [監査対象]
/arch-audit [監査対象]
/ddd-clean-audit [監査対象]
```

## 機能

このコマンドはアーキテクチャ監査エージェント（architecture-auditor）を起動します。エージェントは以下を実行します：

1. **DDD（ドメイン駆動設計）の監査**
   - 戦略的設計の評価
     - 境界づけられたコンテキストの分離状況
     - コンテキストマップの適切性
     - ユビキタス言語の一貫性
     - サブドメインの分類
   - 戦術的設計の評価
     - エンティティと値オブジェクトの適切な使用
     - 集約の境界設定
     - リポジトリパターンの実装状況
     - ドメインサービスの適切性
     - ドメインイベントの活用

2. **クリーンアーキテクチャの監査**
   - レイヤー分離の評価
     - Entities層（エンタープライズビジネスルール）
     - Use Cases層（アプリケーションビジネスルール）
     - Interface Adapters層（コントローラー、プレゼンター、ゲートウェイ）
     - Frameworks & Drivers層（フレームワークとツール）
   - 依存性の方向の検証
     - 依存関係逆転の原則（DIP）の遵守
     - 内側への依存のみ
     - インターフェース分離の原則（ISP）の適用
   - ビジネスロジックの分離
     - ドメインロジックとインフラストラクチャの分離
     - フレームワーク非依存の実装
     - テスタビリティの確保

3. **アンチパターンの検出**
   - DDD関連
     - 貧血ドメインモデル（Anemic Domain Model）
     - 神クラス（God Object）
     - ドメインロジックの漏出
   - クリーンアーキテクチャ関連
     - レイヤー違反
     - フレームワークへの過度な依存
     - ビジネスロジックのコントローラー流出

4. **具体的な改善案の提示**
   - DDDパターンに沿ったリファクタリング案
   - クリーンアーキテクチャに準拠したレイヤー構造の再設計
   - Before/Afterのコード例を含む実装ガイド
   - 優先順位付き改善計画

5. **Issue番号の確認**
   - 監査がどのIssueに紐づくかを確認
   - Issue番号は `U-1234` 形式
   - Gitブランチ名からの自動抽出も試行

6. **監査レポートの保存**
   - `${PLAN_DIRECTORY}/U-[ISSUE番号]_architecture_audit_[ID]_[テーマ].md` 形式で保存
   - 例: `U-1234_architecture_audit_001_ユーザー認証.md`
   - 後から参照・検索しやすい構造化フォーマット

## 監査レポートのフォーマット

生成されるレポートは以下の標準フォーマットに従います：

```markdown
---
audit_id: AUDIT001
title: "[監査対象]のアーキテクチャ監査"
date: YYYY-MM-DD HH:MM:SS
auditor: architecture-auditor agent
focus: [DDD / Clean Architecture / Both]
duration_minutes: XX
status: completed
---

# アーキテクチャ監査レポート: [監査対象]

## エグゼクティブサマリ
- 監査対象の概要
- 主要な発見事項（具体的なファイルパス:行番号を含む）
- 重大度別の問題数（高/中/低）
- 推奨される優先アクション

## 1. DDD監査結果
### 1.1 戦略的設計の評価
- 境界づけられたコンテキスト
- ユビキタス言語

### 1.2 戦術的設計の評価
- エンティティと値オブジェクト
- 集約の設計
- リポジトリパターン

## 2. クリーンアーキテクチャ監査結果
### 2.1 レイヤー分離の評価
- Entities層、Use Cases層、Interface Adapters層、Frameworks & Drivers層

### 2.2 依存性の方向の検証
- DIP、依存の方向、ISP

### 2.3 ビジネスロジックの分離
- ドメインロジックの独立性、フレームワーク依存度、テスタビリティ

## 3. 検出されたアンチパターンと問題
### 3.1 DDD関連の問題
### 3.2 クリーンアーキテクチャ関連の問題

## 4. 改善提案
### 4.1 DDD観点の改善案（Before/Afterコード例付き）
### 4.2 クリーンアーキテクチャ観点の改善案（Before/Afterコード例付き）

## 5. 推奨される実装順序
- フェーズ1: 緊急対応（重大度：高）
- フェーズ2: 計画的改善（重大度：中）
- フェーズ3: 機会的改善（重大度：低）

## 6. 結論
- 総合評価
- 重点的に改善すべき領域
- 長期的な改善計画の提案
```

## 使用例

### 例1: 特定モジュールの監査

```
/architecture-audit ユーザー認証モジュール
```

エージェントの動作：
1. ユーザーにIssue番号を確認（例: U-1234）
2. Issue番号が不明な場合はGitブランチ名から抽出を試行
3. ユーザー認証関連のコードを検索（Glob/Grep）
4. 関連ファイルを読み込んで分析（Read）
5. DDD原則とクリーンアーキテクチャへの準拠状況を評価
6. アンチパターンを検出
7. 具体的な改善案を作成（Before/Afterコード例付き）
8. 統一フォーマットで監査レポートを生成
9. `${PLAN_DIRECTORY}/U-1234_architecture_audit_001_ユーザー認証.md` として保存

### 例2: ディレクトリ全体の監査

```
/arch-audit src/domain/
```

エージェントの動作：
1. Issue番号の確認
2. `src/domain/` ディレクトリ配下を網羅的に監査
3. DDDの戦略的・戦術的設計を評価
4. クリーンアーキテクチャのレイヤー分離を検証
5. 問題点と改善案をレポート化
6. 保存

### 例3: 特定の観点に焦点を当てた監査

```
/ddd-clean-audit 注文処理システム - DDDの集約設計を重点的に
```

エージェントの動作：
1. Issue番号の確認
2. 注文処理システムのコードを特定
3. 特にDDDの集約設計に焦点を当てて監査
4. 集約境界の適切性、トランザクション境界の一致を評価
5. 改善案を提示
6. 保存

## エージェント指示

architecture-auditor エージェントは以下のルールに従います：

### 環境変数の読み込みとIssue番号の確認（最優先）

**監査開始時に必ず実行：**
1. Readツールで `$HOME/.claude/.env` を読み込む
2. `PLAN_DIRECTORY=` で始まる行から保存先ディレクトリの値を抽出
3. この値を監査レポートの保存パスとして使用する

**Issue番号の確認（必須）：**
1. ユーザーに「この監査はどのIssueに紐づきますか？（例: U-1234）」と確認
2. Issue番号が提供されない場合、`git branch --show-current` でブランチ名を取得
3. ブランチ名から `U-\d+` パターンを抽出（例: feature/U-1234-xxx → U-1234）
4. それでも取得できない場合は `NO_ISSUE` を使用
5. 取得したIssue番号をファイル名の先頭に付与

### 必須動作

1. **コードベースの監査**
   - Glob/Grepでファイルを検索
   - Readで実際にコードを読み込んで分析
   - DDDとクリーンアーキテクチャの観点から評価
   - 問題点を特定し、重大度を判定

2. **アンチパターンの検出**
   - 実際のコードから具体的な問題箇所を特定
   - ファイルパス:行番号を明記
   - 問題の影響を評価

3. **改善案の作成**
   - Before/Afterのコード例を含める
   - 実現可能な具体的な実装手順を提示
   - 優先順位と期待される効果を明示

4. **監査レポートの生成**
   - 必ず標準フォーマットに従う
   - メタデータ（監査ID、日時、所要時間）を記録
   - すべての指摘に根拠（ファイルパス:行番号）を明記
   - エグゼクティブサマリを含める

5. **ファイル保存**
   - `${PLAN_DIRECTORY}/U-[ISSUE番号]_architecture_audit_[ID]_[テーマ].md` に保存
   - 例: `U-1234_architecture_audit_001_ユーザー認証.md`
   - ファイル名は日本語可
   - IDは連番（001, 002...）

6. **完了報告**
   - 監査レポートの保存場所を明示
   - 主要な発見事項を簡潔に要約
   - 最優先の推奨アクションを提示

### ハルシネーション防止ルール（最重要）

**絶対に守るべき原則：**

1. **事実確認の徹底**
   - 必ず実際にファイルを検索・読み込んでから指摘する
   - 存在しないファイルやディレクトリについて言及しない
   - 確認していないコードについて断定的に書かない

2. **根拠の明示**
   - すべての指摘に具体的な根拠を示す
   - ファイルパス:行番号を必ず記載
   - 実際のコード例を含める

3. **不明点の明示**
   - わからないことは「わからない」と明記する
   - 推測が必要な場合は「推測」と明示する
   - 確認できなかった事項は「不明点・未確認事項」セクションに記載

4. **推測の禁止**
   - 確認できない情報を勝手に補完しない
   - 「おそらく」「たぶん」「と思われる」などの曖昧な表現を避ける
   - 確実に確認した事実のみを記載

5. **改善案の実現可能性**
   - 提案する改善案は実現可能なものに限る
   - 実際のコードベースの制約を考慮
   - 具体的なコード例を含める

**禁止事項：**
- ❌ 存在しないファイルやディレクトリに言及する
- ❌ 読んでいないコードを「確認した」と書く
- ❌ 確認していない問題を「存在する」と断定する
- ❌ 推測を事実として記載する
- ❌ 理想論だけの実現不可能な改善案を提示する

**推奨行動：**
- ✅ 実際にGlob/Grepツールでファイルを検索する
- ✅ Readツールでファイルの内容を確認する
- ✅ すべての指摘にファイルパス:行番号を含める
- ✅ 不明な点は「監査の結果、確認できませんでした」と正直に書く
- ✅ Before/Afterのコード例を含める
- ✅ 実現可能で具体的な改善案を提示する

### 監査の品質基準
- **完全性**: 監査範囲を明確にし、網羅的に監査
- **正確性**: 事実に基づいた正確な情報のみを記載
- **明確性**: 読みやすく理解しやすい文章で記述
- **有用性**: 実用的で実現可能な改善提案を提示
- **検証可能性**: 他者が同じ結果を再現できる情報を提供
- **誠実性**: わからないことを「わからない」と認める

### エグゼクティブサマリの作成基準
- **簡潔性**: 3-5文で監査の核心を伝える
- **明確性**: 技術的な詳細を避け、本質のみを記載
- **完結性**: サマリだけで監査の全体像が理解できる
- **実用性**: 推奨アクションが具体的で実行可能
- **優先順位**: 最も重要な問題と推奨事項を明確に示す

## 完了メッセージフォーマット

監査完了時に以下のフォーマットで表示：

```
🏛️ アーキテクチャ監査レポートが作成されました
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ファイル: U-[ISSUE番号]_architecture_audit_[ID]_[テーマ].md
Issue番号: U-[ISSUE番号]
監査ID: [ID]
所要時間: XX分
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【監査結果サマリ】
- DDD準拠度: [高/中/低]
- クリーンアーキテクチャ準拠度: [高/中/低]
- 検出された問題: 高: X件、中: Y件、低: Z件

【最優先の推奨アクション】
1. [アクション1]
2. [アクション2]

詳細は監査レポートをご確認ください。
```
